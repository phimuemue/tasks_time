import datetime
import re
import getpass
import os

# Code generation if we want to get all trees (and some even more than once)
def write_all_trees_to_file(source, target, env):
    n = int(env["NUM_THREADS_DEFAULT"])
    path = target
    print ("Generating all trees with %d nodes, writing to %s"%(n,path))
    def generate_all_trees(n):
        """Generates all trees with n+1 (unlabelled) nodes"""
        if n==1:
            yield [(1,0)]
            return
        for tree in generate_all_trees(n-1):
            for i in xrange(n):
                yield [(n,i)] + tree
    f = open(path, "w")
    f.write("// This is an autogenerated file.\n")
    f.write("// Please do not modify this file by hand.\n\n")
    f.write("#ifndef ALLTREES_H\n")
    f.write("#define ALLTREES_H\n\n")
    f.write("#define __E(a,b) pair<Task,Task>(Task(a),Task(b))\n\n")
    f.write("vector<vector<pair<Task,Task>>> alltrees = {\n")
    for t in generate_all_trees(n):
        f.write("    {\n")
        for (a, b) in t:
            f.write("        __E(%d,%d),\n"%(a,b))
        f.write("    },\n")
    f.write("};\n\n")
    f.write("#undef __E\n\n")
    f.write("#endif\n")
    f.close()

# version information
def create_version_info(*a,**b):
    print("Writing version information.")
    f = open(r"info.cpp", "r")
    lines = f.readlines()
    f.close()
    f = open(r"info.cpp", "w")
    for i in xrange(len(lines)):
        if lines[i].startswith("char date"):
            dt = datetime.datetime.now().strftime("%Y/%m/%d %H:%M:%S")
            lines[i] = "char date[] = \"%s\";\n"%(dt)
        if lines[i].startswith("char build"):
            buildno = int(re.search("\"([0-9]*)\"", lines[i]).group(1))
            lines[i] = "char build[] = \"%s\";\n"%(str(buildno+1))
        if lines[i].startswith("char builtby"):
            builtby = getpass.getuser()
            lines[i] = "char builtby[] = \"%s\";\n"%(builtby)
    f.writelines(lines)
    f.close()


# variables
vars = Variables()
vars.Add(EnumVariable("COMPILER", 
            "Compiler command (default g++)", "g++", 
            allowed_values=("g++", "icpc")))
vars.Add(EnumVariable("OPT", 
            "Optimization level can be set to 0, 1, 2 or 3", "3", 
            allowed_values=("0", "1", "2", "3")))
vars.Add("NUM_THREADS_DEFAULT", 
        "Number of threads. Possibly something between 1 and 20", "5")
vars.Add("NUM_PROCESSORS", "Number of processors.", "2")
vars.Add(EnumVariable("SIMPLE_ISOMORPHISM_CHECK", "Simple isomorphism check when computing successors.", 1,
            allowed_values=("0", "1")))
number_types = [(0, "float"), 
                (1, "double"), 
                (2, "rational<int>"), 
                (3, "rational<long>"),
                (4, "mpq_class")]
vars.Add(EnumVariable("MYFLOAT", "Datatype for rational numbers:\n" 
            + "\n".join(["     %d %s"%(x) for x in number_types]), "0",
            allowed_values=("0", "1", "2", "3", "4")))
vars.Add(EnumVariable("USE_SIMPLE_OPENMP", "Simple multithreading for computing topmost successors. Currently only working for value 0.", 0,
            allowed_values=("0", "1")))
vars.Add(EnumVariable("USE_CANONICAL_SNAPSHOT", "Only consider non-isomorphic snapshots", 1, allowed_values=("0", "1")))
vars.Add(EnumVariable("USE_MATULA", "Use matula numbers for canonical snapshots.", 0, allowed_values=("0", "1")))
vars.Add(EnumVariable("USE_TASKMAP", "Set to 1 if tasks in one tree behave different.", 0,
            allowed_values=("0", "1")))
vars.Add(EnumVariable("RELEASE_MODE", "Set to 1 if you want to disable assertions.", 0,
            allowed_values=("0", "1")))

# we use C++11 (mainly to simplify some writing in C++)

env = Environment() 
env = Environment(variables = vars,
                  ENV = {'PATH' : os.environ['PATH']},
                  CXX="${COMPILER}",
                  CXXFLAGS=["-std=c++0x",
                            "-Wall",
                            "-fopenmp", 
                            "-O${OPT}", 
                            "-DNUM_THREADS_DEFAULT=${NUM_THREADS_DEFAULT}",
                            "-DSIMPLE_ISOMORPHISM_CHECK=${SIMPLE_ISOMORPHISM_CHECK}",
                            "-DMYFLOAT=${MYFLOAT}",
                            "-DUSE_SIMPLE_OPENMP=${USE_SIMPLE_OPENMP}",
                            "-DUSE_CANONICAL_SNAPSHOT=${USE_CANONICAL_SNAPSHOT}",
                            "-DUSE_TASKMAP=${USE_TASKMAP}",
                            "-DRELEASE_MODE=${RELEASE_MODE}",
                            ], 
                  LIBS = [
                          "boost_program_options",
                          "python2.7",
                  ],
                  LINKFLAGS="-fopenmp",
                  build_dir = "build"
                 )
env.Append(NEW_VARIABLE = vars);

# adjust debug information if no-optimization
if env["OPT"]=="0":
    env.Append(CXXFLAGS = ["-g"])
# adjust LIBS properly
if env["MYFLOAT"] in ["4"]:
    env.Append(LIBS = ["gmpxx", "gmp"])

# help
Help(vars.GenerateHelpText(env))

# main program
env.Command("info.cpp", "", create_version_info)
targetname = "tasks%s"%(
                            ["_cs0", "_cs1"][int(env["USE_CANONICAL_SNAPSHOT"])]
                        )
print targetname
mainprog = env.Program(target=targetname, source=Glob("*.cpp"))
